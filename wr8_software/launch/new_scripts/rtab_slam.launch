<launch>
    <!-- <include file="$(find wr8_software)/launch/base/serial_uc_link.launch">
        <arg name="publish_tf" default="true"/>
    </include> -->

    <include file="$(find wr8_software)/launch/new_scripts/rs_camera.launch" />
    <arg name="rgb_topic" default="/camera/color/image_raw" />
    <arg name="depth_topic" default="/camera/aligned_depth_to_color/image_raw" />
    <arg name="camera_info_topic" default="/camera/color/camera_info" />


    <!-- Pointcloud to laser scan-->
    <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan_node">
        <remap from="cloud_in" to="/camera/depth/color/points" />
        <remap from="scan" to="/rs_scan" />
        <rosparam>
            target_frame: camera_link
            min_height: 0
            max_height: 1.0
        </rosparam>

    </node>


    <!-- SLAM -->

    <arg name="scan_topic" default="/rs_scan" />
    <arg name="odom_topic" default="/wheel_odom" />

    <arg name="database_path" default="rtabmap.db" />
    <arg name="rtabmapviz" default="false" /> <!--arg for gui: -d $(find rtabmap_ros)/launch/config/rgbd_gui.ini"-->
    <arg name="localization" default="false" />
    <arg if="$(arg localization)" name="args" default="" />
    <arg unless="$(arg localization)" name="args" default="--delete_db_on_start" />
    <arg name="wait_for_transform" default="0.2" />


    <group ns="rtabmap">

        <node pkg="rtabmap_ros" type="rgbd_odometry" name="rgbd_odometry" output="screen">
            <param name="frame_id" type="string" value="base_link" />
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />
            <param name="Reg/Force3DoF" type="string" value="true" />
            <param name="Vis/InlierDistance" type="string" value="0.05" />

            <remap from="rgb/image" to="$(arg rgb_topic)" />
            <remap from="depth/image" to="$(arg depth_topic)" />
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)" />
        </node>

        <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="$(arg args)">
            <param name="database_path" type="string" value="$(arg database_path)" />
            <param name="frame_id" type="string" value="base_link" />
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />
            <param name="subscribe_depth" type="bool" value="true" />
            <param name="subscribe_scan" type="bool" value="true" />
            <param name="odom_frame_id" type="string" value="odom" />
            <param name="odom_tf_angular_variance" type="string" value="0.1" />
            <param name="publish_tf" type="bool" value="true" />

            <!-- inputs -->
            <remap from="odom" to="$(arg odom_topic)" />
            <remap from="scan" to="$(arg scan_topic)" />
            <remap from="rgb/image" to="$(arg rgb_topic)" />
            <remap from="depth/image" to="$(arg depth_topic)" />
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)" />

            <!-- output (for move_base) -->
            <remap from="grid_map" to="/map" />

            <!-- RTAB-Map's parameters -->
            <param name="RGBD/NeighborLinkRefining" type="string" value="true"/>  <!-- Do odometry correction with consecutive laser scans -->
            <param name="RGBD/ProximityBySpace"     type="string" value="true"/>  <!-- Local loop closure detection (using estimated position) with locations in WM -->
            <param name="RGBD/ProximityByTime"      type="string" value="false"/> <!-- Local loop closure detection with locations in STM -->
            <param name="RGBD/ProximityPathMaxNeighbors" type="string" value="10"/> <!-- Do also proximity detection by space by merging close scans together. -->
            <param name="RGBD/LocalRadius"          type="string" value="5"/>     <!-- limit length of proximity detections -->

            <param name="Icp/CorrespondenceRatio"   type="string" value="0.2"/>   <!-- minimum scan overlap to accept loop closure -->
            <param name="Icp/PM"                    type="string" value="false"/>
            <param name="Icp/PointToPlane"          type="string" value="false"/>
            <param name="Icp/MaxCorrespondenceDistance"  type="string" value="0.15"/>
            <param name="Icp/VoxelSize"             type="string" value="0.05"/>

            <param name="Grid/FromDepth"            type="string" value="false"/> <!-- Create 2D occupancy grid from laser scan -->
            <param name="GridGlobal/MinSize" type="string" value="20" />
            
            <!-- <param name="RGBD/ProximityBySpace" type="bool" value="false" /> -->
            <param name="RGBD/OptimizeFromGraphEnd" type="bool" value="false" />
            <param name="RGBD/AngularUpdate" type="string" value="0.01" />
            <param name="RGBD/LinearUpdate" type="string" value="0.01" />
            <param name="Reg/Force3DoF" type="string" value="true" />
            <param name="Reg/Strategy" type="string" value="0" /> <!-- 0=Visual, 1=ICP, 2=Visual+ICP -->
            <param name="Vis/MinInliers" type="string" value="12" />
            <!-- <param name="RGBD/SavedLocalizationIgnored" type="bool" value="true" / >-->

            <!-- localization mode -->
            <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false" />
            <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true" />
            <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)" />
        </node>

        <!-- visualization with rtabmapviz -->
        <node if="$(arg rtabmapviz)" pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" args="" output="screen">
            <param name="frame_id" value="camera_link" />
            <param name="subscribe_depth" type="bool" value="true" />
            <param name="subscribe_scan" type="bool" value="true" />
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />
            <remap from="odom" to="$(arg odom_topic)" />
            <remap from="scan" to="$(arg scan_topic)" />
            <remap from="rgb/image" to="$(arg rgb_topic)" />
            <remap from="depth/image" to="$(arg depth_topic)" />
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)" />
        </node>
    </group>

    <arg name="wp_global_planner" default="false" doc="[true - wp_global_planner, false - global_planner]" />
    <arg name="x" default="15" />
    <arg name="y" default="19" />
    <arg name="yaw" default="0" />

    <include file="$(find wr8_software)/launch/base/move_base.launch">
        <arg name="base_frame" value="base_link" />
        <arg name="odom_frame" value="odom" />
        <arg name="global_frame" value="map" />
        <arg name="odom_topic" value="/rtabmap/odom" />
        <arg name="cmd_topic" value="cmd_vel" />
        <arg name="laser_topic" value="/rs_scan" />
        <arg name="wp_global_planner" value="$(arg wp_global_planner)" />
    </include>


</launch>